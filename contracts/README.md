# CMVH Smart Contracts

**Phase 2 Implementation**: On-chain signature verification for ColiMail Verification Header (CMVH)

## Overview

This package contains the Solidity smart contracts for CMVH email authentication on Arbitrum. The contracts enable on-chain verification of email signatures generated by the CMVH SDK.

### Features

- ✅ **EOA Signature Verification**: ECDSA secp256k1 signature verification
- ✅ **Email Hash Verification**: Canonical email hashing matching SDK
- ✅ **Gas Optimized**: <30k gas for signature verification, <32k for full email verification
- ✅ **OpenZeppelin Security**: Built on battle-tested cryptography libraries
- ✅ **Hardhat 3 + Viem**: Latest development stack

## Project Structure

```
contracts/
├── contracts/
│   ├── CMVHVerifier.sol      # Main verification contract
│   └── Counter.sol            # Example contract (can be removed)
├── test/
│   ├── CMVHVerifier.ts        # Comprehensive test suite (18 tests)
│   ├── SDK-Integration.ts     # SDK interoperability tests
│   └── Counter.ts             # Example tests
├── scripts/
│   └── deploy.ts              # Deployment script
├── ignition/
│   └── modules/
│       └── CMVHVerifier.ts    # Hardhat Ignition deployment module
├── hardhat.config.ts          # Hardhat configuration
├── package.json
└── README.md                  # This file
```

## Quick Start

### Installation

```bash
npm install
```

### Compile Contracts

```bash
npx hardhat compile
```

### Run Tests

```bash
# Run all tests
npx hardhat test

# Run CMVHVerifier tests only
npx hardhat test test/CMVHVerifier.ts

# Run SDK integration tests
npx hardhat test test/SDK-Integration.ts
```

### Deploy Contract

#### Local Deployment

```bash
npx hardhat run scripts/deploy.ts
```

#### Testnet Deployment (Arbitrum Sepolia)

```bash
npx hardhat run scripts/deploy.ts --network arbitrumSepolia
```

#### Using Hardhat Ignition

```bash
npx hardhat ignition deploy ignition/modules/CMVHVerifier.ts --network arbitrumSepolia
```

## Contract API

### CMVHVerifier.sol

#### Core Functions

##### `verifySignature(address signer, bytes32 emailHash, bytes signature) → bool`

Verify ECDSA signature for email hash.

**Gas:** ~28k

##### `verifyEmail(address signer, string subject, string from, string to, string body, bytes signature) → bool`

Verify complete email with inline canonicalization.

**Gas:** ~31k for typical email

#### Helper Functions

##### `recoverSigner(bytes32 emailHash, bytes signature) → address`

Recover signer address from signature.

##### `hashEmail(string subject, string from, string to, string body) → bytes32`

Hash email content using CMVH canonicalization (`subject\nfrom\nto\nbody`).

##### `batchVerifySignatures(address[] signers, bytes32[] emailHashes, bytes[] signatures) → bool[]`

Batch verify multiple signatures efficiently.

## Test Results

```
✔ 18 tests passing
⛽ Gas estimate for verifySignature: 28,027
⛽ Gas estimate for verifyEmail: 31,462
```

**All Phase 2 requirements met:**
- ✅ Signature verification <100k gas
- ✅ Full email verification <150k gas
- ✅ SDK compatibility
- ✅ Comprehensive test coverage

## Security

### Phase 2 Scope
- ✅ EOA signature verification (ECDSA secp256k1)
- ✅ OpenZeppelin ECDSA library
- ✅ Safe error handling

### Known Limitations (By Design for MVP)
- ⚠️ No replay protection (Phase 3+)
- ⚠️ No timestamp validation (Phase 3+)
- ⚠️ No EIP-1271 support (Phase 3+)

## Networks

| Network | Chain ID | RPC URL |
|---------|----------|---------|
| Hardhat Local | 31337 | http://localhost:8545 |
| Arbitrum Sepolia | 421614 | https://sepolia-rollup.arbitrum.io/rpc |
| Arbitrum One | 42161 | https://arb1.arbitrum.io/rpc |

## Integration with SDK

```typescript
import { signEmail } from "@colimail/cmvh-js";
import { createPublicClient, http } from "viem";

// 1. Sign with SDK
const headers = await signEmail({
  from: "alice@example.com",
  to: "bob@example.com",
  subject: "Hello",
  body: "Test",
  privateKey: "0x...",
  chain: "Arbitrum"
});

// 2. Verify on-chain
const isValid = await publicClient.readContract({
  address: verifierAddress,
  abi: CMVHVerifierABI,
  functionName: "verifyEmail",
  args: [signerAddress, subject, from, to, body, signature]
});
```

## Development

Built with:
- **Solidity**: 0.8.28
- **Hardhat**: 3.0.12
- **Viem**: 2.38.6
- **OpenZeppelin Contracts**: 5.4.0

## License

MIT License

## Links

- [Main Documentation](../CMVH_DEV.md)
- [SDK](../sdk/cmvh-js/)
- [OpenZeppelin](https://docs.openzeppelin.com/contracts)
- [Hardhat 3](https://hardhat.org)

---

**Built by ColiMail Labs**
